<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Logsheet Kontrol 5R & Fasilitas</title>
    <!-- Tailwind CSS untuk styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- HTML2PDF Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        /* --- STYLE GLOBAL (Tampilan Web) --- */
        body { background-color: #f3f4f6; font-family: sans-serif; }
        
        .sheet-page {
            background: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border-radius: 0.5rem;
            margin: 20px auto;
            padding: 0;
            width: 100%;
            max-width: 1400px;
            overflow-x: auto;
        }

        /* --- STYLE PRINT BIASA (Ctrl+P) --- */
        @media print {
            @page { size: landscape; margin: 1mm; }
            body { margin: 0; padding: 0; background: white; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .sheet-page { box-shadow: none; margin: 0; border-radius: 0; width: 100%; max-width: none; }
            .no-print { display: none !important; }
            .hide-on-print { display: none !important; }
            .show-on-print { display: block !important; }
            input { border: none !important; padding: 0 !important; background: transparent !important; }
            select { appearance: none; border: none; background: transparent; }
            thead { display: table-header-group; }
            tr { page-break-inside: avoid; }
        }

        /* ==========================================================================
           [EDIT PDF DI SINI] - PENGATURAN KHUSUS MODE DOWNLOAD PDF
           Satuan lebar menggunakan PIXEL (px) agar angka pasti.
           ========================================================================== */

        .pdf-mode {
            /* LEBAR TOTAL HALAMAN (KANVAS) */
            /* Pastikan angka ini > (col-no + col-item + (col-date * 31)) */
            /* 40 + 500 + (22 * 31) = 1222px. Jadi 1300px aman. */
            width: 1300px !important; 
            min-width: 1300px !important;
            
            margin: 0 auto !important;
            background: white !important;
        }

        .pdf-mode .sheet-page {
            width: 85% !important;
            max-width: none !important;
            margin: 0 !important;
            box-shadow: none !important;
            border: none !important;
        }

        /* UKURAN FONT & TABEL */
        .pdf-mode table {
            font-size: 11px !important; 
            width: 100% !important;
            border-collapse: collapse !important;
            table-layout: fixed !important; 
        }

        .pdf-mode th, .pdf-mode td {
            padding: 4px 2px !important; 
            border: 1px solid #374151 !important; 
            vertical-align: middle !important;
            line-height: 1.1 !important;
            word-wrap: break-word !important;
            white-space: normal !important;
        }

        /* --- [EDIT LEBAR KOLOM DI SINI] --- */
        
        /* 1. Lebar Kolom NO */
        .pdf-mode .col-no { 
            width: 25px !important; /* Ganti angka ini jika perlu */
            text-align: center; 
        }
        
        /* 2. Lebar Kolom ITEM PEMERIKSAAN */
        .pdf-mode .col-item { 
            width: 250px !important; /* Ganti angka ini untuk memperlebar/persempit item */
            text-align: left; 
            padding-left: 5px !important; 
        }
        
        /* 3. Lebar Kolom TANGGAL (Per Kotak) */
        /* Total lebar tanggal = Angka ini dikali 31 */
        .pdf-mode .col-date { 
            width: 18px !important; /* Ganti angka ini (misal 20px atau 25px) */
            padding: 2 !important; 
            text-align: center; 
            font-size: 11px !important;
        }

        /* PENGATURAN TAMPILAN RESIK/KATEGORI */
        .pdf-mode .category-label {
            display: block !important;
            font-weight: bold !important;
            font-size: 9px !important; 
            margin-bottom: 2px !important;
            color: #000 !important;
        }
        
        .pdf-mode .item-text {
            display: block !important;
            font-size: 10px !important; 
        }

        /* HEADER & METADATA */
        .pdf-mode .header-content { padding: 5px 10px !important; }
        .pdf-mode h1 { font-size: 18px !important; }
        
        .pdf-mode .metadata-container { 
            padding: 3px 5px !important; 
            gap: 4px !important; 
        }
        
        .pdf-mode label { font-size: 9px !important; margin-bottom: 0 !important; }
        .pdf-mode input, .pdf-mode select, .pdf-mode .dateDisplay {
            font-size: 10px !important; 
            padding: 1px !important;
            height: auto !important;
            margin: 0 !important;
        }

        /* Tinggi Baris Checkbox */
        .pdf-mode .check-cell div { 
            font-size: 10px !important; /* Font checkmark */
            font-weight: bold;
            display: flex; 
            align-items: center; 
            justify-content: center; 
            height: 100%; 
            min-height: 18px; 
        }

        /* --- Utility Classes --- */
        .pdf-mode .no-print { display: none !important; }
        .pdf-mode .hide-on-print { display: none !important; }
        .pdf-mode .show-on-print { display: block !important; }

        /* General Styles Web */
        .check-cell { cursor: pointer; }
        .check-cell:hover { background-color: #eff6ff; }
        .check-cell.active { background-color: #dcfce7 !important; color: #166534; font-weight: bold; }
        .check-cell.sunday { background-color: #fef2f2; }
        .check-cell.sunday.active { background-color: #dcfce7 !important; }
        .hide-on-print { display: block; }
        .show-on-print { display: none; }
    </style>
</head>
<body class="p-4">

    <!-- Controls (Top) -->
    <div class="max-w-[1400px] mx-auto mb-4 flex flex-wrap justify-between items-center no-print">
        <div>
            <h2 class="text-xl font-bold text-gray-800">Formulir 5R Digital (Pixel Fixed)</h2>
            <p class="text-sm text-gray-500">Edit CSS .col-no, .col-item, .col-date untuk atur lebar.</p>
        </div>
        <div class="flex gap-2">
            <button id="btnReset" type="button" class="flex items-center gap-2 px-4 py-2 text-red-600 bg-white border border-red-200 rounded hover:bg-red-50 text-sm font-medium transition-colors shadow-sm">
                <i data-lucide="trash-2" class="w-4 h-4"></i> Reset Data
            </button>
            <button id="btnDownloadPDF" type="button" class="flex items-center gap-2 px-5 py-2 text-white bg-blue-600 rounded hover:bg-blue-700 shadow-md text-sm font-bold transition-colors">
                <i data-lucide="file-down" class="w-4 h-4"></i> Download PDF
            </button>
        </div>
    </div>

    <!-- Container Utama untuk PDF -->
    <div id="contentToPrint">
        
        <div class="sheet-page">
            <!-- Header -->
            <div class="bg-blue-900 text-white p-5 print:bg-white print:text-black print:border-b-2 print:border-black header-content">
                <div class="flex justify-between items-center">
                    <div class="flex items-center gap-4">
                        <i data-lucide="clipboard-list" class="w-8 h-8 text-white print:text-black"></i>
                        <div>
                            <h1 class="text-2xl font-bold uppercase tracking-wide">Logsheet Kontrol 5R & Fasilitas</h1>
                            <p class="opacity-90 text-xs mt-1">Checklist Kebersihan & Kerapihan Area Kerja</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Metadata (Input Utama) -->
            <div class="p-3 grid grid-cols-1 md:grid-cols-4 gap-4 bg-gray-50 border-b print:grid-cols-4 print:text-xs print:p-2 print:bg-transparent metadata-container">
                <div class="flex flex-col">
                    <label class="text-xs font-bold text-gray-500 uppercase mb-1">Bulan & Tahun</label>
                    <div class="flex gap-2 no-print hide-on-print">
                        <select id="monthSelect" class="border p-1.5 rounded text-sm w-full border-gray-300 bg-white"></select>
                        <select id="yearSelect" class="border p-1.5 rounded text-sm w-24 border-gray-300 bg-white"></select>
                    </div>
                    <div class="hidden print:block show-on-print font-bold text-lg dateDisplay"></div>
                </div>
                <div class="flex flex-col md:col-span-2">
                    <label class="text-xs font-bold text-gray-500 uppercase mb-1">Area / Lokasi</label>
                    <input type="text" id="areaInput" placeholder="Isi Lokasi..." class="border p-1.5 rounded text-sm w-full border-gray-300 bg-white print:border-none print:p-0 print:font-bold">
                </div>
                <div class="flex flex-col">
                    <label class="text-xs font-bold text-gray-500 uppercase mb-1">Penanggung Jawab</label>
                    <input type="text" id="inspectorInput" placeholder="Nama Leader" class="border p-1.5 rounded text-sm w-full border-gray-300 bg-white print:border-none print:p-0 print:font-bold">
                </div>
            </div>

            <!-- Table Body -->
            <div class="p-4 print:p-0">
                <table class="w-full text-xs border border-gray-300 shadow-sm">
                    <thead>
                        <tr class="bg-gray-100 print:bg-gray-200">
                            <th rowspan="2" class="p-2 border-gray-400 col-no">No</th>
                            <th rowspan="2" class="p-2 text-left border-gray-400 col-item">Item Pemeriksaan <span class="font-normal italic text-gray-500">(* Mingguan)</span></th>
                            <th class="p-1 text-center font-bold border-gray-400 daysHeader" colspan="31">Tanggal</th>
                        </tr>
                        <tr class="bg-gray-50 print:bg-white dateRow">
                            <!-- Generated by JS -->
                        </tr>
                    </thead>
                    <tbody id="mainTbody">
                        <!-- Generated by JS -->
                    </tbody>
                </table>
            </div>

            <!-- Footer -->
            <div class="p-4 grid grid-cols-1 md:grid-cols-2 gap-4 text-xs text-gray-600 print:grid-cols-2 footer-container">
                <div>
                    <p class="font-bold mb-1">Keterangan:</p>
                    <ul class="list-disc pl-4 space-y-1">
                        <li>Centang (✓) jika <strong>OK</strong>. Kosongkan jika <strong>Tidak Sesuai</strong>.</li>
                        <li>Kolom merah = Hari Minggu/Libur.</li>
                    </ul>
                </div>
                <div class="flex justify-end items-end gap-8 print:gap-16 mt-4">
                    <div class="text-center">
                        <p class="mb-8 font-bold">Dibuat Oleh,</p>
                        <p class="border-t border-black min-w-[150px] pt-1 font-bold text-black" id="signerName">Leader Area</p>
                    </div>
                    <div class="text-center">
                        <p class="mb-8 font-bold">Diketahui Oleh,</p>
                        <p class="border-t border-black min-w-[150px] pt-1">Supervisor / Manager</p>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // --- DATA DEFINITION ---
        const allSections = [
            {
                title: "A. AREA PROSES",
                items: [
                    { id: 1, category: 'Resik', question: 'Pembuangan Sampah All Proses (Sudah dibuang/Kosong)' },
                    { id: 2, category: 'Resik', question: 'Permukaan Lantai All Area Steril dan bersih' },
                    { id: 3, category: 'Ringkas', question: 'Marka Pedestrian terbebas dari Barang-barang maupun Tools' },
                    { id: 4, category: 'Resik', question: 'Area HV, Dokumen dan Non Halal dalam kondisi Steril dan Bersih' },
                    { id: 5, category: 'Rapi', question: 'Area Leader dalam keadaan rapi' },
                    { id: 6, category: 'Rapi', question: 'Barang Holding tersimpan pada Area Holding dengan benar' },
                ]
            },
            {
                title: "B. TOOLS & PERALATAN",
                items: [
                    { id: 7, category: 'Rapi', question: 'Tool diletakkan pada Checkpoint yang ditentukan' },
                    { id: 8, category: 'Ringkas', question: 'Melakukan Sortiran MB Bekas serta merapikan di area Limbah' },
                    { id: 9, category: 'Rawat', question: 'Perawatan Sorting Basket (Kondisi baik/bersih)' },
                    { id: 10, category: 'Rawat', question: 'Perawatan Pigeon Hole (Kondisi baik/bersih)' },
                    { id: 11, category: 'Rawat', question: 'Perawatan Trolly Cage (Roda lancar, tidak rusak)' },
                    { id: 12, category: 'Rawat', question: 'Perawatan Pallet Mesh (Tidak penyok/rusak)' },
                ]
            },
            {
                title: "C. RAK PENYIMPANAN",
                items: [
                    { id: 13, category: 'Rawat', question: 'Perawatan Rak Dokumen dan Tools', isWeekly: true },
                    { id: 14, category: 'Rapi', question: 'Rak dokumen dan Tools dalam keadaan tertata Rapih' },
                ]
            },
            {
                title: "D. PRASARANA & FASILITAS",
                items: [
                    { id: 15, category: 'Rapi', question: 'Area Istirahat/Musholla rapih & terbebas dari barang pribadi' },
                    { id: 16, category: 'Safety', question: 'Memastikan persediaan P3K sesuai dengan standar K3', isWeekly: true },
                    { id: 17, category: 'Rajin', question: 'Informasi board di update (KPI/Pengumuman)', isWeekly: true },
                ]
            }
        ];

        const monthNames = [
            "Januari", "Februari", "Maret", "April", "Mei", "Juni",
            "Juli", "Agustus", "September", "Oktober", "November", "Desember"
        ];

        let currentYear = new Date().getFullYear();
        let currentMonth = new Date().getMonth();
        let checks = {}; 
        const STORAGE_PREFIX = "5R_LOGSHEET_V12_PX_"; 

        document.addEventListener('DOMContentLoaded', () => {
            init();
            
            const btnReset = document.getElementById('btnReset');
            const btnDownload = document.getElementById('btnDownloadPDF');

            if(btnReset) btnReset.addEventListener('click', (e) => { e.preventDefault(); resetData(); });
            if(btnDownload) btnDownload.addEventListener('click', (e) => { e.preventDefault(); downloadPDF(); });

            const area = document.getElementById('areaInput');
            const insp = document.getElementById('inspectorInput');
            
            area.addEventListener('input', (e) => { saveMetadata(); });
            insp.addEventListener('input', (e) => {
                document.getElementById('signerName').innerText = e.target.value || 'Leader Area';
                saveMetadata();
            });
        });

        function init() {
            // Restore filters
            const storedMonth = localStorage.getItem(STORAGE_PREFIX + 'lastMonth');
            const storedYear = localStorage.getItem(STORAGE_PREFIX + 'lastYear');
            
            if(storedMonth !== null) currentMonth = parseInt(storedMonth);
            if(storedYear !== null) currentYear = parseInt(storedYear);

            const yearSelect = document.getElementById('yearSelect');
            for(let y = new Date().getFullYear() - 2; y <= new Date().getFullYear() + 2; y++) {
                const opt = document.createElement('option');
                opt.value = y;
                opt.text = y;
                if(y === currentYear) opt.selected = true;
                yearSelect.appendChild(opt);
            }

            const monthSelect = document.getElementById('monthSelect');
            monthNames.forEach((m, i) => {
                const opt = document.createElement('option');
                opt.value = i;
                opt.text = m;
                if(i === currentMonth) opt.selected = true;
                monthSelect.appendChild(opt);
            });

            yearSelect.addEventListener('change', (e) => { 
                currentYear = parseInt(e.target.value); 
                localStorage.setItem(STORAGE_PREFIX + 'lastYear', currentYear);
                loadDataForCurrentMonth(); 
                renderTable(); 
            });
            
            monthSelect.addEventListener('change', (e) => { 
                currentMonth = parseInt(e.target.value); 
                localStorage.setItem(STORAGE_PREFIX + 'lastMonth', currentMonth);
                loadDataForCurrentMonth(); 
                renderTable(); 
            });

            loadDataForCurrentMonth();
            renderTable();
            if (window.lucide) lucide.createIcons();
        }

        function getStorageKey() {
            return `${STORAGE_PREFIX}${currentYear}_${currentMonth}`;
        }

        function loadDataForCurrentMonth() {
            const key = getStorageKey();
            const rawData = localStorage.getItem(key);
            
            const area = document.getElementById('areaInput');
            const insp = document.getElementById('inspectorInput');
            const signer = document.getElementById('signerName');

            if (rawData) {
                const data = JSON.parse(rawData);
                checks = data.checks || {};
                
                if(data.area) area.value = data.area;
                if(data.inspector) {
                    insp.value = data.inspector;
                    signer.innerText = data.inspector;
                }
            } else {
                checks = {};
            }
        }

        function saveMetadata() {
            const key = getStorageKey();
            const dataToSave = {
                checks: checks,
                area: document.getElementById('areaInput').value,
                inspector: document.getElementById('inspectorInput').value
            };
            localStorage.setItem(key, JSON.stringify(dataToSave));
        }

        function renderTable() {
            const dateStr = `${monthNames[currentMonth]} ${currentYear}`;
            document.querySelectorAll('.dateDisplay').forEach(el => el.innerText = dateStr);
            
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            const daysHeader = document.querySelector('.daysHeader');
            const dateRow = document.querySelector('.dateRow');
            const tbody = document.getElementById('mainTbody');

            daysHeader.colSpan = daysInMonth;
            dateRow.innerHTML = '';
            for (let d = 1; d <= daysInMonth; d++) {
                const th = document.createElement('th');
                th.className = "border border-gray-300 text-center text-[10px] p-1 col-date";
                th.innerText = d;
                dateRow.appendChild(th);
            }

            tbody.innerHTML = '';
            
            allSections.forEach(section => {
                const sectionRow = document.createElement('tr');
                sectionRow.className = "bg-blue-100 print:bg-gray-300";
                sectionRow.innerHTML = `
                    <td colspan="${daysInMonth + 2}" class="p-2 font-bold text-sm border border-gray-400 text-blue-900 print:text-black">
                        ${section.title}
                    </td>
                `;
                tbody.appendChild(sectionRow);

                section.items.forEach(item => {
                    const row = document.createElement('tr');
                    const rowClass = item.isWeekly ? "hover:bg-blue-50 transition-colors bg-yellow-50/50" : "hover:bg-blue-50 transition-colors";
                    row.className = rowClass;

                    let badgeClass = 'text-gray-700 bg-gray-50 border-gray-200';
                    if(item.category === 'Ringkas') badgeClass = 'text-red-700 bg-red-50 border-red-200';
                    if(item.category === 'Rapi') badgeClass = 'text-blue-700 bg-blue-50 border-blue-200';
                    if(item.category === 'Resik') badgeClass = 'text-green-700 bg-green-50 border-green-200';
                    if(item.category === 'Rawat') badgeClass = 'text-purple-700 bg-purple-50 border-purple-200';
                    if(item.category === 'Safety') badgeClass = 'text-orange-700 bg-orange-50 border-orange-200';

                    const weeklyBadge = item.isWeekly ? `⚠️` : '';
                    const weeklyAsterisk = item.isWeekly ? `<span class="text-red-500 font-bold ml-1">*</span>` : '';

                    // HTML STRUKTUR TUMPUK (Kategori atas, Soal bawah)
                    let html = `
                        <td class="border border-gray-300 text-center p-1 font-mono text-[10px] text-gray-500 col-no">${item.id}</td>
                        <td class="border border-gray-300 p-1 px-2 col-item">
                            <div class="flex flex-col justify-center">
                                <div class="mb-0.5 category-label">
                                    <span class="badge-span px-1 rounded text-[9px] border ${badgeClass} print:border-none print:bg-transparent print:text-black print:px-0 print:font-bold">
                                        [${item.category}]
                                    </span>
                                    <span class="text-[9px]">${weeklyBadge}</span>
                                </div>
                                <div class="leading-tight text-[11px] text-gray-600 print:text-black item-text">
                                    ${item.question} ${weeklyAsterisk}
                                </div>
                            </div>
                        </td>
                    `;

                    for (let d = 1; d <= daysInMonth; d++) {
                        const dateObj = new Date(currentYear, currentMonth, d);
                        const isSunday = dateObj.getDay() === 0;
                        const key = `${item.id}-${d}`;
                        const isChecked = checks[key] === true;
                        
                        const cellClass = `border border-gray-300 text-center p-0 check-cell ${isSunday ? 'sunday' : ''} ${isChecked ? 'active' : ''} col-date`;
                        
                        html += `
                            <td class="${cellClass}" onclick="toggleCheck(${item.id}, ${d}, this)">
                                <div class="w-full h-full min-h-[24px] flex items-center justify-center text-[14px]">
                                    ${isChecked ? '✓' : ''}
                                </div>
                            </td>
                        `;
                    }
                    row.innerHTML = html;
                    tbody.appendChild(row);
                });
            });

            // Paraf Row
            const parafRow = document.createElement('tr');
            parafRow.className = "print:h-12";
            let parafHtml = `
                <td colspan="2" class="border border-gray-300 p-2 text-right font-bold italic text-gray-500">
                    Paraf Leader
                </td>
            `;
            for (let d = 1; d <= daysInMonth; d++) {
                parafHtml += `<td class="border border-gray-300"></td>`;
            }
            parafRow.innerHTML = parafHtml;
            tbody.appendChild(parafRow);
        }

        window.toggleCheck = function(itemId, day, cellElement) {
            const key = `${itemId}-${day}`;
            if (checks[key]) {
                delete checks[key];
                cellElement.classList.remove('active');
                cellElement.querySelector('div').innerText = '';
            } else {
                checks[key] = true;
                cellElement.classList.add('active');
                cellElement.querySelector('div').innerText = '✓';
            }
            saveMetadata();
        }

        window.resetData = function() {
            Swal.fire({
                title: 'Hapus Data?',
                text: "Data " + monthNames[currentMonth] + " akan dihapus.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                confirmButtonText: 'Hapus!'
            }).then((result) => {
                if (result.isConfirmed) {
                    checks = {};
                    saveMetadata();
                    renderTable();
                    Swal.fire('Terhapus!', '', 'success');
                }
            })
        }

        window.downloadPDF = function() {
            // Scroll to top to ensure capture isn't blank
            window.scrollTo(0,0);
            
            const element = document.getElementById('contentToPrint');
            element.classList.add('pdf-mode');
            
            const inputs = element.querySelectorAll('input');
            inputs.forEach(input => { input.setAttribute('value', input.value); });

            const opt = {
                margin:       [5, 5, 5, 5], 
                filename:     `Logsheet_5R_${monthNames[currentMonth]}_${currentYear}_F4_Safe.pdf`,
                image:        { type: 'jpeg', quality: 0.98 },
                html2canvas:  { 
                    scale: 2, 
                    useCORS: true, 
                    scrollY: 0,
                    // PENTING: Lebar virtual 1300px agar sinkron dengan CSS
                    windowWidth: 1300 
                },
                // Ukuran F4 [215mm, 330mm] Landscape
                jsPDF:        { unit: 'mm', format: [215, 330], orientation: 'landscape' },
                pagebreak:    { mode: ['css', 'legacy'] } 
            };

            html2pdf().set(opt).from(element).save().then(() => {
                element.classList.remove('pdf-mode');
            });
        }
    </script>
</body>
</html>